@page "/dashboard"
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="dashboard-container animate-fade-in">
    <!-- HEADER -->
    <div class="dash-header">
        <div class="welcome-text">
            <h1>Dashboard Tổng Quan</h1>
            <p>Thống kê dữ liệu năm học 2025-2026</p>
        </div>
        <div class="dash-actions">
            <div class="date-display">
                <i class="bi bi-calendar-event"></i> @DateTime.Now.ToString("dd/MM/yyyy")
            </div>
            <button class="btn-glass"><i class="bi bi-bell"></i></button>
            <div class="user-pill">
                <img src="https://ui-avatars.com/api/?name=Admin&background=random" alt="Admin" />
                <span>Admin Trường</span>
            </div>
        </div>
    </div>

    <!-- KPI CARDS -->
    <div class="kpi-row">
        <div class="kpi-card gradient-purple">
            <div class="kpi-icon"><i class="bi bi-people"></i></div>
            <div class="kpi-info">
                <h3>803</h3>
                <span>Tổng học sinh</span>
            </div>
            <div class="kpi-chart-mini">
                <svg viewBox="0 0 100 30" class="sparkline"><path d="M0,30 Q20,10 40,20 T100,0" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="3" /></svg>
            </div>
        </div>

        <div class="kpi-card gradient-blue">
            <div class="kpi-icon"><i class="bi bi-person-badge"></i></div>
            <div class="kpi-info">
                <h3>379</h3>
                <span>Cán bộ / Giáo viên</span>
            </div>
            <div class="kpi-progress">
                <div class="progress-bar" style="width: 85%"></div>
                <small>85% Đã đồng bộ</small>
            </div>
        </div>

        <div class="kpi-card gradient-orange">
            <div class="kpi-icon"><i class="bi bi-pen"></i></div>
            <div class="kpi-info">
                <h3>92%</h3>
                <span>Tiến độ ký số</span>
            </div>
            <div class="kpi-trend">
                <i class="bi bi-arrow-up-right"></i> +5% tuần qua
            </div>
        </div>

        <div class="kpi-card gradient-green">
            <div class="kpi-icon"><i class="bi bi-check2-circle"></i></div>
            <div class="kpi-info">
                <h3>650</h3>
                <span>Học bạ hoàn thành</span>
            </div>
            <div class="kpi-trend">
                <i class="bi bi-check-all"></i> Đạt chỉ tiêu
            </div>
        </div>
    </div>

    <!-- MAIN CHARTS AREA -->
    <div class="charts-row">
        <div class="chart-card main-chart">
            <div class="card-header">
                <h3>Tiến độ ký sổ môn học theo Khối</h3>
                <button class="btn-icon"><i class="bi bi-three-dots"></i></button>
            </div>
            <div class="chart-body">
                <canvas id="signingChart"></canvas>
            </div>
        </div>

        <div class="chart-card side-chart">
            <div class="card-header">
                <h3>Kết quả giáo dục</h3>
            </div>
            <div class="chart-body relative">
                <canvas id="gradeChart"></canvas>
                <div class="chart-center-text">
                    <span>Tổng</span>
                    <strong>803</strong>
                </div>
            </div>
            <div class="chart-legend">
                <div class="legend-item"><span class="dot good"></span> Tốt (48%)</div>
                <div class="legend-item"><span class="dot avg"></span> Khá (30%)</div>
                <div class="legend-item"><span class="dot pass"></span> Đạt (22%)</div>
            </div>
        </div>
    </div>

    <!-- TABLE: DANH SÁCH HỌC SINH CẦN CẬP NHẬT THÔNG TIN -->
    <div class="recent-section">
        <div class="card-header">
            <h3><i class="bi bi-exclamation-circle text-warning me-2"></i> Học sinh cần cập nhật thông tin hồ sơ</h3>
            <div class="header-actions">
                <select class="filter-select-sm" @bind="SelectedClass">
                    <option value="All">Tất cả lớp</option>
                    <option value="6A1">Lớp 6A1</option>
                    <option value="9B2">Lớp 9B2</option>
                </select>
                <a href="/hoc-sinh" class="view-all">Đến trang quản lý hồ sơ <i class="bi bi-arrow-right"></i></a>
            </div>
        </div>
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th width="250">Học sinh / Mã định danh</th>
                        <th width="100" class="text-center">Lớp</th>
                        <th>Thông tin thiếu / Sai sót</th>
                        <th width="150">GV Chủ nhiệm</th>
                        <th width="120" class="text-center">Mức độ</th>
                        <th width="120" class="text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in DataIssues)
                    {
                        <tr>
                            <td>
                                <div class="student-cell">
                                    <div class="avatar-xs bg-light text-primary fw-bold">@item.StudentName.Substring(0, 1)</div>
                                    <div class="student-info">
                                        <span class="name">@item.StudentName</span>
                                        <span class="code">@item.StudentId</span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge-gray">@item.Class</span>
                            </td>
                            <td>
                                <span class="issue-text text-danger">
                                    <i class="bi bi-x-circle me-1"></i> @item.IssueDescription
                                </span>
                            </td>
                            <td>
                                <span class="teacher-name">@item.TeacherName</span>
                            </td>
                            <td class="text-center">
                                @if (item.Severity == "High")
                                {
                                    <span class="status-pill error">Quan trọng</span>
                                }
                                else
                                {
                                    <span class="status-pill warning">Cần bổ sung</span>
                                }
                            </td>
                            <td class="text-center">
                                <button class="btn-fix" title="Cập nhật ngay">
                                    <i class="bi bi-pencil-square"></i> Sửa
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!DataIssues.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i class="bi bi-check-circle-fill text-success fs-4 d-block mb-2"></i>
                                Tuyệt vời! Không có hồ sơ nào bị thiếu dữ liệu.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    window.renderDashboardCharts = () => {
        const ctxBar = document.getElementById('signingChart').getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Khối 6', 'Khối 7', 'Khối 8', 'Khối 9'],
                datasets: [{
                    label: 'Đã ký',
                    data: [85, 72, 90, 65, 95],
                    backgroundColor: '#3b82f6',
                    borderRadius: 6,
                    barPercentage: 0.6
                }, {
                    label: 'Chưa ký',
                    data: [15, 28, 10, 35, 5],
                    backgroundColor: '#e2e8f0',
                    borderRadius: 6,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, grid: { borderDash: [5, 5] } }
                },
                plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true } } }
            }
        });

        const ctxDoughnut = document.getElementById('gradeChart').getContext('2d');
        new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: ['Tốt', 'Khá', 'Đạt'],
                datasets: [{
                    data: [48, 30, 22],
                    backgroundColor: ['#10b981', '#f59e0b', '#64748b'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: { legend: { display: false } }
            }
        });
    };
</script>

@code {
    private string SelectedClass = "All";

    public class DataIssueItem
    {
        public string StudentName { get; set; }
        public string StudentId { get; set; }
        public string Class { get; set; }
        public string IssueDescription { get; set; }
        public string TeacherName { get; set; }
        public string Severity { get; set; } // High, Medium
    }

    private List<DataIssueItem> DataIssues = new();

    protected override void OnInitialized()
    {
        // Mock Data: Danh sách học sinh thiếu thông tin
        DataIssues = new List<DataIssueItem>
        {
            new DataIssueItem { StudentName = "Lê Văn An", StudentId = "HS001", Class = "6A1", IssueDescription = "Thiếu thông tin Số CCCD/Định danh", TeacherName = "Cô Uyên", Severity = "High" },
            new DataIssueItem { StudentName = "Trần Thị Bích", StudentId = "HS002", Class = "9B2", IssueDescription = "Chưa có ảnh thẻ học bạ", TeacherName = "Thầy Hùng", Severity = "Medium" },
            new DataIssueItem { StudentName = "Nguyễn Quốc Cường", StudentId = "HS003", Class = "7A3", IssueDescription = "Thiếu điểm tổng kết môn GDTC", TeacherName = "Cô Mai", Severity = "High" },
            new DataIssueItem { StudentName = "Phạm Hồng Đào", StudentId = "HS004", Class = "8C1", IssueDescription = "Sai định dạng Ngày sinh", TeacherName = "Thầy Tuấn", Severity = "Medium" },
            new DataIssueItem { StudentName = "Hoàng Văn Em", StudentId = "HS005", Class = "6A1", IssueDescription = "Thiếu thông tin Nơi sinh", TeacherName = "Cô Uyên", Severity = "Medium" }
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("renderDashboardCharts");
        }
    }
}