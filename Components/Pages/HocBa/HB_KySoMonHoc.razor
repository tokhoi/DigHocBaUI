@page "/ky-so-mon-hoc"
@rendermode InteractiveServer
@using DigHocBaUI.Models

<div class="page-wrapper">
    <div class="toolbar">
        <h2 class="page-title">Ký số môn học</h2>
        <div class="filter-group">
            <select class="form-select w-150">
                <option>Ngữ Văn</option>
                <option>Toán</option>
            </select>

            <select class="form-select w-150"><option>Khối 6</option></select>

            <!-- DROPDOWN LỚP: LOGIC QUAN TRỌNG -->
            <select class="form-select w-150" @bind="SelectedLop">
                <option value="">-- Tất cả lớp --</option>
                @foreach (var lop in AvailableClasses)
                {
                    <option value="@lop">@lop</option>
                }
            </select>

            <div class="search-box">
                <input type="text" placeholder="Nhập tên HS..." />
                <button class="btn-search"><i class="bi bi-search"></i></button>
            </div>
        </div>
    </div>

    <div class="action-right">
        <button class="btn btn-green">
            <i class="bi bi-pen-fill"></i> Ký số (@FilteredList.Count(x => x.TrangThaiKy == "Đợi ký"))
        </button>
    </div>

    <div class="grid-panel">
        <table class="vnedu-table">
            <thead>
                <tr>
                    <th width="40"><input type="checkbox" /></th>
                    <th width="50">STT</th>
                    <th>MÃ ĐỊNH DANH</th>
                    <th class="text-start">HỌ VÀ TÊN</th>
                    <!-- Hiển thị cột Lớp để debug -->
                    <th class="text-center">LỚP</th>
                    <th>HK1</th>
                    <th>HK2</th>
                    <th>CẢ NĂM</th>
                    <th>NGƯỜI KÝ</th>
                    <th>TRẠNG THÁI</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in PagedList)
                {
                    <tr>
                        <td><input type="checkbox" /></td>
                        <td class="text-center">@item.STT</td>
                        <td>@item.MaDinhDanh</td>
                        <td class="text-start font-bold">@item.HoTen</td>
                        <td class="text-center"><span class="badge badge-gray">@item.Lop</span></td>
                        <td>@item.DiemHK1</td>
                        <td>@item.DiemHK2</td>
                        <td>@item.DiemCaNam</td>
                        <td>@item.NguoiKy</td>
                        <td>
                            <span class="status-text @(item.TrangThaiKy == "Đã ký" ? "done" : "pending")">
                                @item.TrangThaiKy
                            </span>
                        </td>
                    </tr>
                }
                @if (!PagedList.Any())
                {
                    <tr><td colspan="10" class="text-center text-muted p-4">Không tìm thấy dữ liệu</td></tr>
                }
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    @if (TotalPages > 1)
    {
        <div class="pagination-container">
            <span class="pagination-info">Trang @currentPage / @TotalPages</span>
            <div class="pagination-controls">
                <button class="page-btn" disabled="@(currentPage == 1)" @onclick="() => ChangePage(currentPage - 1)">‹</button>
                @for (int i = 1; i <= TotalPages; i++)
                {
                    var p = i;
                    <button class="page-btn @(currentPage == p ? "active" : "")" @onclick="() => ChangePage(p)">@p</button>
                }
                <button class="page-btn" disabled="@(currentPage == TotalPages)" @onclick="() => ChangePage(currentPage + 1)">›</button>
            </div>
        </div>
    }
</div>

@code {
    // 1. Mock User Info (Giả lập user đang đăng nhập)
    private UserInfo CurrentUser = new UserInfo
    {
        Name = "Nguyễn Văn A",
        Role = "GVCN",
        LopChuNhiem = "6A1" // <-- Mấu chốt ở đây
    };

    // 2. State & Data
    private string _selectedLop = "";
    // Khi thay đổi dropdown, reset trang về 1
    public string SelectedLop
    {
        get => _selectedLop;
        set { _selectedLop = value; currentPage = 1; }
    }

    private List<string> AvailableClasses = new List<string> { "6A1", "6A2", "6A3", "7A1" };

    private int currentPage = 1;
    private int pageSize = 10;
    private List<HocBaItem> FullList = new();

    // 3. Filtering Logic
    private List<HocBaItem> FilteredList => FullList
        .Where(x => string.IsNullOrEmpty(SelectedLop) || x.Lop == SelectedLop)
        .ToList();

    private List<HocBaItem> PagedList => FilteredList
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    private int TotalPages => (int)Math.Ceiling((double)FilteredList.Count / pageSize);

    protected override void OnInitialized()
    {
        // 4. NGHIỆP VỤ: Tự động chọn lớp nếu là GVCN
        if (CurrentUser.Role == "GVCN" && !string.IsNullOrEmpty(CurrentUser.LopChuNhiem))
        {
            SelectedLop = CurrentUser.LopChuNhiem;
        }

        // Tạo dữ liệu giả (Trộn lẫn nhiều lớp)
        GenerateMockData();
    }

    private void GenerateMockData()
    {
        for (int i = 1; i <= 50; i++)
        {
            // Random lớp để test tính năng lọc
            string lop = (i % 3 == 0) ? "6A2" : (i % 3 == 1) ? "6A1" : "6A3";

            FullList.Add(new HocBaItem
            {
                STT = i,
                MaDinhDanh = $"HS00{i}",
                HoTen = $"Học sinh {i}",
                Lop = lop,
                DiemHK1 = 8.5,
                DiemHK2 = 9.0,
                DiemCaNam = 8.8,
                NguoiKy = "Lâm Hoàng Phúc",
                TrangThaiKy = (i % 5 == 0) ? "Đợi ký" : "Đã ký"
            });
        }
    }

    private void ChangePage(int newPage) { if (newPage >= 1 && newPage <= TotalPages) currentPage = newPage; }

    // Models
    public class UserInfo { public string Name; public string Role; public string LopChuNhiem; }
    public class HocBaItem
    {
        public int STT; public string MaDinhDanh; public string HoTen; public string Lop;
        public double DiemHK1; public double DiemHK2; public double DiemCaNam;
        public string NguoiKy; public string TrangThaiKy;
    }
}